<html>
<head>
  <title>INFINITE TRAILER</title>
  <style>
    video {
      display: table;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 100%;
      position: absolute;
      margin: auto;
    }
    #trailer {
      z-index: 1;
    }
    #trailer-b {
      z-index: 0;
    }
  </style>
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
</head>
<body style="background-color: black;">
  <video id="trailer" width="100%" onended="nextVideo()"></video>
<script>

var videoPlayer = document.getElementById('trailer');

var videos = null;
var timeOut = null;
var fadeOutTimeMs = 300;
var fadeInTimeMs = 100;

videoPlayer.addEventListener('loadedmetadata', function() {
  var durationMs = Math.round(videoPlayer.duration * 1000);
  timeOut = setTimeout(function() {
    $(videoPlayer).animate({volume: 0}, fadeOutTimeMs);
  }, durationMs - fadeOutTimeMs);
});

function getRandomVideoSrc() {
  var randomIndex = Math.floor(Math.random() * videos.length);
  return videos[randomIndex];
}

function nextVideo() {
  videoPlayer.src = getRandomVideoSrc();
  console.log(videoPlayer.src);
  videoPlayer.controls = false;
  videoPlayer.volume = 0;
  if (timeOut != null) {
    clearTimeout(timeOut);
  }
  $(videoPlayer).animate({volume: 1}, fadeInTimeMs);
  videoPlayer.play();
}

var req = new XMLHttpRequest();
req.overrideMimeType('application/json');
req.open('GET', 'listings.json', true);
req.onreadystatechange = function(request, url) {
  if (req.readyState == 4) {
    if (req.status == 200) {
      console.log(req.responseText);
      videos = JSON.parse(req.responseText).videos;
      nextVideo();
    }
  }
};
req.send(null);

</script>
</body>
</html>
